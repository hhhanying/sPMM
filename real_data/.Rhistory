# Fungi
x = dat[182:199]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
alpha_;beta_;mu_;sigma2_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_-1,sqrt(sigma2_/lambda_sim[x])))
mean_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_/lambda_sim[x])))
mean_sim%>%ggdensity()
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_/lambda_sim[x])))
mean_sim%>%ggdensity()
dt[view == "Bacteria"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
dt[view == "Fungi"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2/2_/lambda_sim[x])))
mean_sim%>%ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_/2/lambda_sim[x])))
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_/2/lambda_sim[x])))
mean_sim%>%ggdensity()
dt[view == "Fungi"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
sigma2_ = sigma2_/2
c(alpha_,beta_,mu_,sigma2_) # 3.2438328 11.1157220 -1.0000000  0.9138574
c(alpha_,beta_,mu_,sigma2_)
# Viruses
x = dat[200:241]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
alpha_;beta_;mu_;sigma2_
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
means = sapply(x, function(x) mean(x[which(x<=2.5)]))
vars = sapply(x, function(x) var(x[which(x<=2.5)]))
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
alpha_;beta_;mu_;sigma2_
# Viruses
x = dat[200:241]
means = sapply(x, function(x) mean(x[which(x<=2.5)]))
vars = sapply(x, function(x) var(x[which(x<=2.5)]))
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
lambdas %>% ggdensity()
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
means %>% ggdensity()
View(dat)
dat = dat %>% arrance(Category)
View(dat)
dat = dat %>% arrange(Category)
library(purrr)
dat = dat %>% arrange(Category)
dat = dat %>% arrange(Category)
library(tidyverse)
library(purrr)
dat = dat %>% arrange(Category)
library(data.table)
library(tidyverse)
library(purrr)
library(ggplot2)
library(ggpubr)
library(MOFA2)
library(dplyr)
dt <- fread("ftp://ftp.ebi.ac.uk/pub/databases/mofa/microbiome/data.txt.gz")
metadata <- fread("ftp://ftp.ebi.ac.uk/pub/databases/mofa/microbiome/metadata.txt.gz")
str(dt)
dim(dt)
str(metadata)
dim(metadata)
dt_wide = copy(dt)[, fea := paste(feature, view, sep = "_")][,c("sample","value","fea")] %>%
reshape(idvar = "sample", timevar = "fea", direction = "wide")
names(dt_wide)[2:241] = sapply(names(dt_wide)[2:241], function(x) substring(x,7))
dat = copy(metadata)[, Category := case_when(
Category == "Sepsis" ~ 0,
Category == "Non septic ICU" ~ 1,
Category == "Healthy, no antibiotics" ~ 2,
Category == "Healthy, antibiotics" ~ 3)][, c("sample", "Category")]
dat = merge(dt_wide, dat, by="sample")
row.has.na <- apply(dat, 1, function(x){any(is.na(x))})
dat$sample[row.has.na] # "TKI_F22" "TKI_F56"
dat = dat[!row.has.na,]
dat = dat %>% arrange(Category)
write.csv(dat, "./data/cleaned_data.csv",row.names = FALSE)
dat_test = read.csv("./data/cleaned_data.csv")
View(dat_test)
########################
# data description:    #
# dim(dat): 57, 242    #
# col 2-181: Bacteria  #
# col 182-199: Fungi   #
# col 200-241: Viruses #
########################
table(dat$Category)
23+9
sample(1:10,10)
a,b = 1,2
# data description:                     #
# dim(dat): 57, 242                     #
# col 2-181: Bacteria                   #
# col 182-199: Fungi                    #
# col 200-241: Viruses                  #
# row 1-23: 0(Sepsis)                   #
# row 24-32: 1(Non septic ICU)          #
# row 33-52: 2(Healthy, no antibiotics) #
# row 53-57: 3(Healthy, antibiotics)    #
#########################################
g0 = sample(1:23, 23 )
g1 = sample(24:32, 9)
g2 = sample(33:52, 20)
g3 = sample(53:57, 5)
i1 = c(g0[1:5],g1[1:2],g2[1:4],g3[1])
i2 = c(g0[6:10],g1[3:4],g2[5:8],g3[2])
i3 = c(g0[11:14],g1[5:6],g2[9:12],g3[3])
i4 = c(g0[15:18],g1[7:8],g2[13:16],g3[4])
i5 = c(g0[19:23],g1[9],g2[17:20],g3[5])
i1
i2
i3
i4
i5
# data description:                     #
# dim(dat): 57, 242                     #
# col 2-181: Bacteria                   #
# col 182-199: Fungi                    #
# col 200-241: Viruses                  #
# row 1-23: 0(Sepsis)                   #
# row 24-32: 1(Non septic ICU)          #
# row 33-52: 2(Healthy, no antibiotics) #
# row 53-57: 3(Healthy, antibiotics)    #
#########################################
g0 = sample(0:22, 23 )
g1 = sample(23:31, 9)
g2 = sample(32:51, 20)
g3 = sample(52:56, 5)
i1 = c(g0[1:5],g1[1:2],g2[1:4],g3[1])
i2 = c(g0[6:10],g1[3:4],g2[5:8],g3[2])
i3 = c(g0[11:14],g1[5:6],g2[9:12],g3[3])
i4 = c(g0[15:18],g1[7:8],g2[13:16],g3[4])
i5 = c(g0[19:23],g1[9],g2[17:20],g3[5])
i1 # 9  8 11  5 13 31 24 51 45 47 40 57
i2 # 22 19 21  7 17 28 29 34 44 36 38 54
i3 # 18  2 16  4 27 26 33 50 49 39 53
i4 # 14  3  6 15 32 25 42 52 37 41 55
i5 # 12 20 23  1 10 30 48 43 46 35 56
# Viruses
x = dat[200:241]
means = sapply(x, function(x) mean(x[which(x<=2.5)]))
vars = sapply(x, function(x) var(x[which(x<=2.5)]))
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
# Viruses
x = dat[200:241]
means = sapply(x, function(x) mean(x[which(x<=2.5)]))
dat
means = sapply(x, function(x) mean(x[which(x<=2.5)]))
dt <- fread("ftp://ftp.ebi.ac.uk/pub/databases/mofa/microbiome/data.txt.gz")
dat_copy = copy(dt)
# bacteria
dt[view == "Bacteria"] %>% ggdensity( x="value", fill="gray70")
mean(dt[view == "Bacteria"]$value)
# bacteria
## estimate prior for Lambda
x = dat[2:181]
means = sapply(x, mean)
vars = sapply(x, var)
dt <- fread("ftp://ftp.ebi.ac.uk/pub/databases/mofa/microbiome/data.txt.gz")
dat = read.csv("./data/cleaned_data.csv")
dat_copy = copy(dt)
# bacteria
## estimate prior for Lambda
x = dat[2:181]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
lambdas %>% ggdensity()
rgamma(1000,alpha_Bac, beta_Bac )%>%ggdensity()
lambdas %>% ggdensity()
lambdas %>% ggdensity()
rgamma(1000,alpha_, beta_)%>%ggdensity()
# bacteria
## estimate prior for Lambda
x = dat[2:181]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_-1,sqrt(sigma2_/lambda_sim[x])))
mean_sim%>%ggdensity()
dt[view == "Bacteria"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
mu_ = mu_ - 1
c(alpha_,beta_,mu_,sigma2_)
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
# bacteria
## estimate prior for Lambda
x = dat[2:181]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_-1,sqrt(sigma2_/lambda_sim[x])))
mean_sim%>%ggdensity()
dt[view == "Bacteria"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
mu_ = mu_ - 1
c(alpha_,beta_,mu_,sigma2_)
# Fungi
x = dat[182:199]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
alpha_;beta_;mu_;sigma2_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_/2/lambda_sim[x])))
mean_sim%>%ggdensity()
dt[view == "Bacteria"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
sigma2_ = sigma2_/2
c(alpha_,beta_,mu_,sigma2_) # 3.2438328 11.1157220 -1.0000000  0.9138574
alpha_;beta_;mu_;sigma2_
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
alpha_;beta_;mu_;sigma2_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
lambdas %>% ggdensity()
# Viruses
x = dat[200:241]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)
means %>% ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
mu_ = mean(means)-1
sigma2_ = var(means)
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
sigma2_ = var(means)/2
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
sigma2_ = var(means)/4
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
sigma2_ = var(means)/6
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
means %>% ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/6
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
alpha_;beta_;mu_;sigma2_
dt[view == "Fungi"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
# Fungi
x = dat[182:199]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
alpha_;beta_;mu_;sigma2_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_/2/lambda_sim[x])))
mean_sim%>%ggdensity()
dt[view == "Fungi"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
sigma2_ = sigma2_/2
c(alpha_,beta_,mu_,sigma2_) # 3.416767e+00 1.105094e+01 1.446800e-16 6.660274e-01
# Viruses
x = dat[200:241]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/6
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Bacteria"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
# Viruses
x = dat[200:241]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/6
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
# Viruses
x = dat[200:241]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
# Viruses
x = dat[200:241]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/6
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
sigma2_
sigma2_ = 1
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/6
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
sigma2_ = var(means)/12
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
beta_ = beta_*2
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/12
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
beta_ = mean(lambdas)/var(lambdas)
beta_ = beta_*2
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/12
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
beta_ = mean(lambdas)/var(lambdas)
beta_ = beta_
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
# Viruses
x = dat[200:241]
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
beta_ = beta_
alpha_ = mean(lambdas)*beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
mu_ = mean(means)
sigma2_ = var(means)/12
means %>% ggdensity()
mean_sim = sapply(1:1000, function(x) rnorm(1,mu_,sqrt(sigma2_)))
mean_sim%>%ggdensity()
dt[view == "Viruses"] %>% ggdensity( x="value", fill="gray70")
x_sim = sapply(1:1000, function(x) rnorm(1,mean_sim[x],sqrt(1/lambda_sim[x])))
x_sim%>%ggdensity()
alpha_;beta_;mu_;sigma2_
c(alpha_,beta_,mu_,sigma2_) #
means = sapply(x, mean)
vars = sapply(x, var)
lambdas = 1/vars
beta_ = mean(lambdas)/var(lambdas)
alpha_ = mean(lambdas)*beta_
mu_ = mean(means)
sigma2_ = var(means)*(alpha_-1)/beta_
lambdas %>% ggdensity()
lambda_sim = rgamma(1000,alpha_, beta_)
lambda_sim%>%ggdensity()
